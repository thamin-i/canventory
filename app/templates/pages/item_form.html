{% extends "base.html" %}

{% block title %}{{ 'Edit' if item else 'Add' }} Item - Canventory{% endblock %}
{% block body_class %}app-page{% endblock %}

{% include "header.html" %}

{% block content %}

<main class="form-container">
    <form method="post" enctype="multipart/form-data" class="item-form-card">
        {% if error %}
        <div class="error-message show">{{ error }}</div>
        {% endif %}

        <div class="form-row">
            <div class="form-group">
                <label for="name">Name *</label>
                <input type="text" id="name" name="name" required maxlength="255"
                    value="{{ item.name if item else (prefill.name if prefill else '') }}">
            </div>
            <div class="form-group">
                <label for="quantity">Quantity *</label>
                <input type="number" id="quantity" name="quantity" required min="1"
                    value="{{ item.quantity if item else 1 }}">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="category">Category</label>
                <select id="category" name="category">
                    {% for cat in categories %}
                    <option value="{{ cat.value }}" {% if item and item.category==cat.value %}selected {% elif not item
                        and prefill and prefill.category==cat.value %}selected {% endif %}>
                        {{ cat.label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="expiration_date">Expiration Date *</label>
                <input type="date" id="expiration_date" name="expiration_date" required
                    value="{{ item.expiration_date[:10] if item else default_date }}">
            </div>
        </div>

        <div class="form-group">
            <label for="location">Storage Location</label>
            <div class="autocomplete-wrapper">
                <input type="text" id="location" name="location" placeholder="Type to search or create new..."
                    value="{{ item.location_name if item and item.location_name else '' }}" maxlength="100"
                    autocomplete="off">
                <div class="autocomplete-dropdown" id="location-dropdown"></div>
            </div>
            <small class="form-hint">üìç Where is this item stored? (e.g., Fridge, Kitchen Closet, Pantry)</small>
        </div>

        <script>
            (function () {
                const locations = {{ locations | tojson | safe
            }};
            const input = document.getElementById('location');
            const dropdown = document.getElementById('location-dropdown');
            let selectedIndex = -1;

            function showSuggestions(filter) {
                const value = filter.toLowerCase().trim();
                dropdown.innerHTML = '';
                selectedIndex = -1;

                if (!value) {
                    // Show all locations when empty and focused
                    if (locations.length === 0) {
                        dropdown.style.display = 'none';
                        return;
                    }
                }

                const filtered = value
                    ? locations.filter(loc => loc.name.toLowerCase().includes(value))
                    : locations;

                if (filtered.length === 0 && value) {
                    // Show "create new" option
                    const createItem = document.createElement('div');
                    createItem.className = 'autocomplete-item autocomplete-create';
                    createItem.innerHTML = '<span class="autocomplete-icon">‚ú®</span> Create "<strong>' + escapeHtml(filter) + '</strong>"';
                    createItem.addEventListener('click', () => {
                        input.value = filter;
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(createItem);
                    dropdown.style.display = 'block';
                    return;
                }

                if (filtered.length === 0) {
                    dropdown.style.display = 'none';
                    return;
                }

                filtered.forEach((loc, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.dataset.index = index;

                    // Highlight matching text
                    let displayName = escapeHtml(loc.name);

                    if (value) {
                        const regex = new RegExp('(' + escapeRegex(value) + ')', 'gi');
                        displayName = displayName.replace(regex, '<mark>$1</mark>');
                    }

                    item.innerHTML = '<span class="autocomplete-icon">üìç</span><span>' + displayName + '</span>';
                    item.addEventListener('click', () => {
                        input.value = loc.name;
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(item);
                });

                // Show "create new" option if input doesn't exactly match
                if (value && !filtered.some(loc => loc.name.toLowerCase() === value)) {
                    const createItem = document.createElement('div');
                    createItem.className = 'autocomplete-item autocomplete-create';
                    createItem.dataset.index = filtered.length;
                    createItem.innerHTML = '<span class="autocomplete-icon">‚ú®</span> Create "<strong>' + escapeHtml(filter) + '</strong>"';
                    createItem.addEventListener('click', () => {
                        input.value = filter;
                        dropdown.style.display = 'none';
                    });
                    dropdown.appendChild(createItem);
                }

                dropdown.style.display = 'block';
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            function updateSelection() {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    items[selectedIndex].scrollIntoView({ block: 'nearest' });
                }
            }

            input.addEventListener('input', (e) => {
                showSuggestions(e.target.value);
            });

            input.addEventListener('focus', () => {
                showSuggestions(input.value);
            });

            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSelection();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    items[selectedIndex].click();
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                    selectedIndex = -1;
                }
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }) ();
        </script>

        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="3"
                maxlength="1000">{{ item.description if item and item.description else (prefill.description if prefill else '') }}</textarea>
        </div>

        <div class="form-group">
            <label>Image</label>
            <div class="image-upload-area" id="image-upload-area">
                <input type="file" id="image" name="image" accept="image/*">
                {% if item and item.has_image %}
                <div class="current-image">
                    <img src="/web/items/{{ item.id }}/image" alt="Current image">
                    <p>Current image (upload new to replace)</p>
                </div>
                <label class="remove-image-label">
                    <input type="checkbox" name="remove_image" value="1">
                    Remove current image
                </label>
                {% endif %}
            </div>
        </div>

        <div class="form-actions">
            <a href="/web/dashboard" class="btn btn-ghost">Cancel</a>
            <button type="submit" class="btn btn-primary">
                <span>{{ 'Save Changes' if item else 'Add Item' }}</span>
            </button>
        </div>
    </form>
</main>

{% endblock %}
