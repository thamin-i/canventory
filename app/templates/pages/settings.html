{% extends "base.html" %}

{% block title %}Settings - Canventory{% endblock %}
{% block body_class %}app-page{% endblock %}

{% include "header.html" %}

{% block content %}

{% if message %}
<div class="alert-banner success">
    <span>âœ… {{ message }}</span>
</div>
{% endif %}

{% if error %}
<div class="alert-banner error">
    <span>âŒ {{ error }}</span>
</div>
{% endif %}

<!-- Settings Container -->
<main class="settings-container">
    <!-- Notifications Section -->
    <section class="settings-card">
        <div class="settings-card-header">
            <h2>âœ‰ï¸ Notifications</h2>
            <p class="settings-description">Configure how you receive alerts about expiring items</p>
        </div>

        <div class="settings-section">
            <h3>Email Notifications</h3>
            <div class="setting-row">
                <div class="setting-info">
                    <span class="setting-label">Email Alerts</span>
                    <span class="setting-help">Receive daily email digests about expiring items at {{ user.email
                        }}</span>
                </div>
                <div class="setting-control">
                    <button id="email-toggle" class="toggle-button" onclick="toggleEmailNotifications()" {% if not
                        smtp_enabled %}disabled{% endif %}>
                        <span class="toggle-icon {% if user.email_notifications_enabled %}hidden{% endif %}"
                            id="email-icon-off">ğŸ”•</span>
                        <span class="toggle-icon {% if not user.email_notifications_enabled %}hidden{% endif %}"
                            id="email-icon-on">ğŸ””</span>
                        <span class="toggle-text" id="email-status">{% if user.email_notifications_enabled %}Enabled{%
                            else %}Enable{% endif %}</span>
                    </button>
                </div>
            </div>
            <div class="setting-row {% if not user.email_notifications_enabled %}hidden{% endif %}" id="test-email-row">
                <div class="setting-info">
                    <span class="setting-label">Test Email</span>
                    <span class="setting-help">Send a test email to verify everything is working</span>
                </div>
                <div class="setting-control">
                    <button class="btn btn-ghost" onclick="sendTestEmail()" {% if not smtp_enabled %}disabled{% endif
                        %}>
                        ğŸ§ª Test
                    </button>
                </div>
            </div>

            {% if not smtp_enabled %}
            <div class="setting-warning">
                <span>âš ï¸</span>
                <span>Email notifications are not available. SMTP is not configured on the server.</span>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Account Section -->
    <section class="settings-card">
        <div class="settings-card-header">
            <h2>ğŸ‘¤ Account</h2>
            <p class="settings-description">Your account information</p>
        </div>

        <!-- Account Info -->
        <div class="settings-section">
            <div class="account-info-grid">
                <div class="account-info-item">
                    <span class="account-label">Username</span>
                    <span class="account-value">{{ user.username }}</span>
                </div>
                <div class="account-info-item">
                    <span class="account-label">Email</span>
                    <span class="account-value" id="current-email">{{ user.email }}</span>
                </div>
                <div class="account-info-item">
                    <span class="account-label">Role</span>
                    <span class="account-value">
                        {% if user.is_admin %}
                        <span class="badge badge-admin">ğŸ‘‘ Administrator</span>
                        {% else %}
                        <span class="badge badge-user">User</span>
                        {% endif %}
                    </span>
                </div>
                <div class="account-info-item">
                    <span class="account-label">Member since</span>
                    <span class="account-value">{{ user.created_at }}</span>
                </div>
            </div>
        </div>

        <!-- Change Email -->
        <div class="settings-section">
            <h3>Change Email</h3>
            <form id="email-form" class="security-form" onsubmit="changeEmail(event)">
                <div class="form-group">
                    <label for="new-email">New Email Address</label>
                    <input type="email" id="new-email" name="new_email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="email-password">Password</label>
                    <input type="password" id="email-password" name="password" required autocomplete="current-password">
                    <span class="setting-help">Confirm your password to change email</span>
                </div>
                <div class="form-actions-inline">
                    <button type="submit" class="btn btn-primary">Update Email</button>
                </div>
            </form>
        </div>
    </section>

    <!-- Security Section -->
    <section class="settings-card">
        <div class="settings-card-header">
            <h2>ğŸ” Security</h2>
            <p class="settings-description">Manage your password and email</p>
        </div>

        <!-- Change Password -->
        <div class="settings-section">
            <h3>Change Password</h3>
            <form id="password-form" class="security-form" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" name="current_password" required
                        autocomplete="current-password">
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" name="new_password" required minlength="8"
                        autocomplete="new-password">
                    <span class="setting-help">Minimum 8 characters</span>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" name="confirm_password" required minlength="8"
                        autocomplete="new-password">
                </div>
                <div class="form-actions-inline">
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </div>
            </form>
        </div>
    </section>

</main>

{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', path='js/pages/settings.js') }}"
    data-email-enabled="{{ 'true' if user.email_notifications_enabled else 'false' }}"></script>
{% endblock %}
